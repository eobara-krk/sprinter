<main>
  <div class="placeholder">

    <!-- HEADER Z LOGO, DATƒÑ I AUDIO -->
    <div class="header">
      <!-- Uk≈Çad dwukolumnowy: Lewa (logo+tytu≈Ç) | Prawa (data+audio) -->
      <div class="header-top-line">
        <!-- LEWA STRONA: Logo + Tytu≈Ç g≈Ç√≥wny -->
        <div class="left-column">
          <div class="logo-section">
            <img src="assets/sprint.png" alt="Sprint" 
                 (load)="onImageLoad($event)" 
                 (error)="onImageError($event)"
                 loading="lazy" />
          </div>
          <div class="header-title">
              <h1>Podsumowania sprint√≥w <br>2025 r.</h1>
          </div>
        </div>
  <!-- Usuniƒôto nadmiarowy zamykajƒÖcy tag div po zakomentowanej sekcji left-column -->
        
        <!-- PRAWA STRONA: Data + Audio -->
        <div class="right-column">
          <div style="width: 140px; display: flex; flex-direction: column; align-items: center;">
            <img src="assets/Logo_KRUK_cmyk2.png" alt="Logo"
              class="logo-section-img"
              style="max-width: 110px; max-height: 110px; width: auto; height: auto; background: transparent; margin-bottom: 8px; display: block;"
              (load)="onImageLoad($event)"
              (error)="onImageError($event)"
              loading="lazy" />
          
            <div class="date-line" style="text-align: center; width: 100%;">
              <br>
              <h2 style="font-size:1.1em; margin:0;">{{ currentDateTime | date:'EEEE dd.MM.yyyy':'':'pl-PL' }} r.</h2>
            </div>
          </div>
       
        </div>
      </div>
    </div>

  <hr class="custom-divider">
    <div class="divider"></div>

    <!-- EVENTY -->
  <div *ngFor="let item of items; let i = index, trackBy: trackByTitle" class="event-card" [attr.id]="'folder-' + i">

  <!-- Nag≈Ç√≥wek wydarzenia g√≥wny folder z pineskƒÖ-->
  <div class="event-header" (click)="toggle(item)">
  <span>üìå <span class="event-title" [innerHTML]="item.title"></span></span>
  <span>{{ item.show ? '‚ñ≤' : '‚ñº' }}</span>
      </div>

      <!-- Zawarto≈õƒá wydarzenia -->
      <div class="pill-group" *ngIf="item.show">

        <!-- Miniatura obrazka wydarzenia -->
        <div class="event-image-container" *ngIf="item.image">
          <img [src]="item.image"
               alt="Obraz wydarzenia"
               class="event-thumb"
               (click)="toggleFullscreen(item.image); $event.stopPropagation();" />

        </div>

        <!-- GRUPY LINK√ìW I OPISY -->
        <div class="groups-container">
          <ng-container *ngFor="let group of item.links; trackBy: trackByName">


            <!-- Miniaturka grupy -->
            <div class="event-image-container" *ngIf="group.image">
              <img [src]="group.image"
                   alt="Obraz grupy"
                   class="event-thumb"
                   (click)="toggleFullscreen(group.image); $event.stopPropagation();" />
            </div>

            <!-- OPIS -->
            <div *ngIf="group.type==='opis'" class="grid-link description-link" (click)="openOnly(group, item)">
              <span *ngIf="group.protected">üîí</span>
              <span *ngIf="!group.protected">üìù</span>
              {{ group.name }}

              <div *ngIf="group.show && group.text" class="event-description">
                <div class="justified-text" [innerHTML]="textFormatService.processTextWithLinks(group.text)"></div>
              </div>
            </div>

              <!-- Wy≈õwietl nazwƒô grupy, je≈õli nie ma opisu ani link√≥w, ale jest podgrupa 'PrzeglƒÖd kodu' -->
              <div *ngIf="!group.type && group.links && group.links.length === 1 && (group.links[0].name === 'PrzeglƒÖd kodu' || group.links[0].name === 'zalacznik')" class="group-container">
                <div class="grid-link main-link" (click)="group.links[0].show = !group.links[0].show; $event.stopPropagation();">
                  <span class="expand-icon">{{ group.links[0].show ? '‚ñº' : '‚ñ∂' }}</span>
                  <span *ngIf="group.links[0].name && group.links[0].name.toLowerCase().includes('przeglƒÖd')" style="color:#2563eb;font-size:1.3em">üíª</span>
                  <!-- folder tylko dla zalacznik -->
                  <ng-container *ngIf="group.links[0].name === 'zalacznik'">
                    <span class="folder-icon" style="color:gold">üìÅ</span>
                  </ng-container>
                    <span class="zadanie-label">{{ group.links[0].name }}</span>
                </div>
                <!-- Album zdjƒôƒá w podgrupie lub PDF-y w zalacznik -->
                <div *ngIf="group.links[0].show" class="sub-links-container">
                  <photo-gallery *ngIf="group.links[0].name === 'PrzeglƒÖd kodu' && hasPhotoElements(group.links[0].links || []) && getPhotoCount(group.links[0].links || []) > 1"
                    [photos]="getPhotoElements(group.links[0].links || [])"
                    [groupName]="group.links[0].name || ''">
                  </photo-gallery>
                  <ng-container *ngIf="group.links[0].name === 'zalacznik'">
                    <div class="pdf-list">
                      <a *ngFor="let pdf of group.links[0].links" class="grid-link sub-link pdf-item" [href]="pdf.url" target="_blank" rel="noopener">
                        <span class="pdf-icon">
                          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="3" width="18" height="18" rx="4" fill="#d32f2f"/>
                            <text x="6" y="17" font-size="10" font-family="Arial, sans-serif" fill="#fff" font-weight="bold">PDF</text>
                          </svg>
                        </span>
                        <span [innerHTML]="pdf.label || pdf.url"></span>
                      </a>
                    </div>
                  </ng-container>
                </div>
              </div>

            <!-- GRUPA Z WIELOMA LINKAMI (nie jest opisem i ma wiƒôcej ni≈º 1 link) -->
            <div *ngIf="group.type !== 'opis' && group.links && group.links.length > 1" 
                 class="group-container"
                 [class.expanded]="group.show"
                 (click)="openOnly(group, item); $event.stopPropagation()">
                 
              <!-- G≈Ç√≥wny link grupy -->
              <div class="grid-link main-link">
                <span class="expand-icon">{{ group.show ? '‚ñº' : '‚ñ∂' }}</span>
                <span>üìÅ</span>
                <span class="zadanie-label">{{ group.name }}</span>
              </div>

              <!-- PODLINKI (grupy z wieloma linkami) -->
              <ng-container *ngIf="group.show && group.links as links">
                <div *ngIf="links.length > 1" class="sub-links-container">
                  <div class="connection-line"></div>
                  <div class="link-grid" [class.photo-grid]="hasPhotoElements(links)">
                <ng-container *ngFor="let l of links">
                  
                  <!-- Je≈õli link ma zagnie≈ºd≈ºone linki -->
                  <ng-container *ngIf="l.links && l.links.length > 0">
                    <div class="nested-group">
                      <div class="nested-header" (click)="toggleOnlyNestedGroup(l, links); $event.stopPropagation()">
                        <span class="nested-icon">{{ l.show ? '‚ñº' : '‚ñ∂' }}</span>
                        <span class="folder-icon" style="color:gold">üìÅ</span>
                        <ng-container *ngIf="l.name !== 'PrzeglƒÖd kodu'; else kodIcon"></ng-container>
                        <ng-template #kodIcon><span style="color:#2563eb;font-size:1.3em">üíª</span> PrzeglƒÖd kodu</ng-template>
                      </div>
                      <!-- Zagnie≈ºd≈ºone linki -->
                      <div *ngIf="l.show" class="nested-links">
                        <photo-gallery *ngIf="hasPhotoElements(l.links) && getPhotoCount(l.links) > 1"
                          [photos]="getPhotoElements(l.links)"
                          [groupName]="l.name || ''">
                        </photo-gallery>
                        <ng-container *ngFor="let nestedLink of l.links">
                          <ng-container *ngIf="nestedLink.links && nestedLink.links.length > 0; else leafLink">
                            <div class="nested-group">
                              <div class="nested-header" (click)="toggleOnlyNestedGroup(nestedLink, l.links); $event.stopPropagation()">
                                <span class="nested-icon">{{ nestedLink.show ? '‚ñº' : '‚ñ∂' }}</span>
                                <span class="folder-icon" style="color:gold">üìÅ</span>
                                <ng-container *ngIf="nestedLink.name !== 'PrzeglƒÖd kodu'; else kodIcon2"></ng-container>
                                <ng-template #kodIcon2><span style="color:#2563eb;font-size:1.3em">üíª</span> PrzeglƒÖd kodu</ng-template>
                              </div>
                              <div *ngIf="nestedLink.show" class="nested-links">
                                <photo-gallery *ngIf="hasPhotoElements(nestedLink.links) && getPhotoCount(nestedLink.links) > 1"
                                  [photos]="getPhotoElements(nestedLink.links)"
                                  [groupName]="nestedLink.name || ''">
                                </photo-gallery>
                                <ng-container *ngFor="let deepLink of nestedLink.links">
                                  <ng-container *ngIf="deepLink.links && deepLink.links.length > 0; else deepLeaf">
                                    <div class="nested-group">
                                      <div class="nested-header" (click)="toggleOnlyNestedGroup(deepLink, nestedLink.links); $event.stopPropagation()">
                                        <span class="nested-icon">{{ deepLink.show ? '‚ñº' : '‚ñ∂' }}</span>
                                        <span class="folder-icon" style="color:gold">üìÅ</span>
                                        <ng-container *ngIf="deepLink.name !== 'PrzeglƒÖd kodu'; else kodIcon3"></ng-container>
                                        <ng-template #kodIcon3><span style="color:#2563eb;font-size:1.3em">üíª</span> PrzeglƒÖd kodu</ng-template>
                                      </div>
                                      <div *ngIf="deepLink.show" class="nested-links">
                                        <photo-gallery *ngIf="hasPhotoElements(deepLink.links) && getPhotoCount(deepLink.links) > 1"
                                          [photos]="getPhotoElements(deepLink.links)"
                                          [groupName]="deepLink.name || ''">
                                        </photo-gallery>
                                        <ng-container *ngFor="let leaf of deepLink.links">
                                          <ng-container *ngIf="leaf.links && leaf.links.length > 0; else leafLeaf">
                                            <!-- Jeszcze g≈Çƒôbiej: kolejne poziomy -->
                                          </ng-container>
                                          <ng-template #leafLeaf>
                                            <a class="grid-link nested-link"
                                               
                                               [href]="leaf.url || null"
                                               target="_blank"
                                               rel="noopener"
                                               (click)="$event.stopPropagation()">
                                              
                                              <span class="sub-icon">‚û§‚û§</span>
                                              <span [ngSwitch]="leaf.type">
                                                <span *ngSwitchCase="'film'">üé¨</span>
                                                <span *ngSwitchCase="'pdf'">üìï</span>
                                                <span *ngSwitchCase="'exec'">üíø</span>
                                                <span *ngSwitchCase="'foto'">üì∑</span>
                                                <span *ngSwitchCase="'audio'">üéµ</span>
                                                <span *ngSwitchCase="'youtube'">üì∫</span>
                                                <span *ngSwitchCase="'html'">üåê</span>
                                                <span *ngSwitchDefault>üìÅ</span>
                                              </span>
                                              {{ leaf.label || leaf.url }}
                                            </a>
                                          </ng-template>
                                        </ng-container>
                                      </div>
                                    </div>
                                  </ng-container>
                                  <ng-template #deepLeaf>
                                    <a class="grid-link nested-link"
                                       
                                       [href]="deepLink.url || null"
                                       target="_blank"
                                       rel="noopener"
                                       (click)="$event.stopPropagation()">
                                      
                                      <span class="sub-icon">‚û§‚û§</span>
                                      <span [ngSwitch]="deepLink.type">
                                        <span *ngSwitchCase="'film'">üé¨</span>
                                        <span *ngSwitchCase="'pdf'">üìï</span>
                                        <span *ngSwitchCase="'exec'">üíø</span>
                                        <span *ngSwitchCase="'foto'">üì∑</span>
                                        <span *ngSwitchCase="'audio'">üéµ</span>
                                        <span *ngSwitchCase="'youtube'">üì∫</span>
                                        <span *ngSwitchCase="'html'">üåê</span>
                                        <span *ngSwitchDefault>üìÅ</span>
                                      </span>
                                      {{ deepLink.label || deepLink.url }}
                                    </a>
                                  </ng-template>
                                </ng-container>
                              </div>
                            </div>
                          </ng-container>
                          <ng-template #leafLink>
                            <a class="grid-link nested-link"
                               
                               [href]="nestedLink.url || null"
                               target="_blank"
                               rel="noopener"
                               (click)="$event.stopPropagation()">
                              
                              <span class="sub-icon">‚û§‚û§</span>
                              <span [ngSwitch]="nestedLink.type">
                                <span *ngSwitchCase="'film'">üé¨</span>
                                <span *ngSwitchCase="'pdf'">üìï</span>
                                <span *ngSwitchCase="'exec'">üíø</span>
                                <span *ngSwitchCase="'foto'">üì∑</span>
                                <span *ngSwitchCase="'audio'">üéµ</span>
                                <span *ngSwitchCase="'youtube'">üì∫</span>
                                <span *ngSwitchCase="'html'">üåê</span>
                                <span *ngSwitchDefault>üìÅ</span>
                              </span>
                              {{ nestedLink.label || nestedLink.url }}
                            </a>
                          </ng-template>
                        </ng-container>
                      </div>
                    </div>
                  </ng-container>

                  <!-- Zwyk≈Çy link (bez zagnie≈ºd≈ºonych link√≥w) -->
                  <ng-container *ngIf="!l.links || l.links.length === 0">
                    <!-- Element foto (tylko zdjƒôcie) -->
                    <div *ngIf="l.type==='foto'" 
                         class="grid-link sub-link foto-item">
                       <div class="link-thumb-container">
                        <img [src]="l.image" 
                             alt="Miniaturka" 
                             class="link-thumb"
                             loading="lazy"
                             decoding="async"
                             (load)="onImageLoad($event)"
                             (error)="onImageError($event)"
                             (click)="toggleFullscreen(l.image); $event.preventDefault(); $event.stopPropagation();" />
                        <span class="link-label" *ngIf="l.label" [innerHTML]="l.label"></span>
                      </div>
                      
                    </div>

                    <!-- Element PDF z ikonƒÖ -->
                    <a *ngIf="l.type==='pdf' && l.url" 
                       class="grid-link sub-link pdf-item"
                       [href]="l.url"
                       target="_blank"
                       rel="noopener">
                      <span class="pdf-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <rect x="3" y="3" width="18" height="18" rx="4" fill="#d32f2f"/>
                          <text x="6" y="17" font-size="10" font-family="Arial, sans-serif" fill="#fff" font-weight="bold">PDF</text>
                        </svg>
                      </span>
                      <span [innerHTML]="l.label || l.url"></span>
                    </a>

                    <!-- Element tekstowy (opis w podlinku) -->
                    <div *ngIf="l.type==='opis' && l.text" class="grid-link sub-link text-item" style="position:relative;">
                      <!-- Etykieta gdy tekst jest zwiniƒôty -->
                      <div *ngIf="!l.show" class="text-collapsed-header" (click)="textVisibilityService.toggleTextVisibility(l); $event.stopPropagation();">
                        <div class="text-collapsed-left">
                          <span class="text-icon">üìù</span>
                          <div class="text-toggle-label" [innerHTML]="l.label || 'Czu≈Çe serce ≈õw. Ludwika'"></div>
                        </div>
                        <span class="text-toggle-icon">‚ñº</span>
                      </div>
                    </div>
                  </ng-container>
                </ng-container>
                  </div>
                </div>
              </ng-container>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

    <!-- STOPKA w kontenerku -->
    <div class="footer-section">
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div style="font-size: 0.95em; color: #666;">Przydatne linki:  <a href="https://krukeu.sharepoint.com/sites/ITINTHQPL/SitePages/bibliotekaszablonow.aspx" target="_blank" rel="noopener">bibliotek szablon√≥w</a></div>
        <div class="znak-wodny">
          ¬© <span class="ozdobne">EO</span>
        </div>
      </div>
      <button class="close-button" (click)="closePage()">
        <span class="close-icon">√ó</span>
        <span class="close-text">Zamknij stronƒô</span>
      </button>
    </div>


<!-- FULLSCREEN IMAGE - overlay poza main -->
<div id="fullscreen-overlay" class="fullscreen-local" *ngIf="fullscreenImage" (click)="toggleFullscreen()">
  <img [src]="fullscreenImage" 
       class="fullscreen-local-image"
       loading="eager"
       decoding="async" />
</div>

<!-- FULLSCREEN TEXT - overlay poza main -->
<div *ngFor="let item of items" style="display:contents">
  <ng-container *ngFor="let group of item.links">
    <ng-container *ngFor="let l of group.links">
      <div class="text-fullscreen-overlay" *ngIf="l.type==='opis' && l.text && l.show" (click)="textVisibilityService.toggleTextVisibility(l)">
        <div class="text-fullscreen-content" (click)="textVisibilityService.toggleTextVisibility(l)">
          <button (click)="textVisibilityService.toggleTextVisibility(l)" class="close-text-btn" title="Zamknij tekst" style="position:absolute; top:12px; right:12px; background:#2563eb; border:none; font-size:1.3em; cursor:pointer; color:#fff; z-index:10; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 8px rgba(59,130,246,0.18);">‚úñ</button>
          <div class="sub-text" style="font-size:1.3em; font-weight:600; margin-bottom:1em; color:#2563eb;">{{ l.label }}</div>
          <div class="sub-text" [innerHTML]="textFormatService.processTextWithLinks(l.text)"></div>
        </div>
      </div>
    </ng-container>
  </ng-container>
</div>

<!-- FULLSCREEN PHOTO ALBUM - overlay poza main -->
<div *ngFor="let item of items" style="display:contents">
  <ng-container *ngFor="let group of item.links">
    <ng-container *ngFor="let l of group.links">
      <div *ngIf="l.name === 'PrzeglƒÖd kodu' && l.show && hasPhotoElements(l.links || []) && getPhotoCount(l.links || []) > 1" class="fullscreen-local" (click)="toggleOnlyNestedGroup(l, group.links || [])">
        <div (click)="$event.stopPropagation()">
          <photo-gallery [photos]="getPhotoElements(l.links || [])" [groupName]="l.name || ''"></photo-gallery>
        </div>
      </div>
    </ng-container>
  </ng-container>
</div>
